openapi: 3.0.0
info:
  title: PFP Service API
  version: 1.0.0
  description: API for managing Products & Portfolios
servers:
  - url: /api
    description: Main API server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
  schemas:
    Product:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        product_type:
          type: string
        currency:
          type: string
        min_term_months:
          type: integer
        max_term_months:
          type: integer
        min_amount:
          type: number
        max_amount:
          type: number
        yields:
          type: array
          items:
            $ref: '#/components/schemas/ProductYield'
    ProductYield:
      type: object
      properties:
        term_from_months:
          type: integer
        term_to_months:
          type: integer
        amount_from:
          type: number
        amount_to:
          type: number
        yield_percent:
          type: number
    Portfolio:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        currency:
          type: string
        amount_from:
          type: number
        amount_to:
          type: number
        term_from_months:
          type: integer
        term_to_months:
          type: integer
        classes:
          type: array
          items:
            type: object # simplified
        riskProfiles:
          type: array
          items:
            $ref: '#/components/schemas/PortfolioRiskProfile'
    PortfolioRiskProfile:
      type: object
      properties:
        profile_type:
          type: string
          enum: [CONSERVATIVE, BALANCED, AGGRESSIVE]
        potential_yield_percent:
          type: number
        instruments:
          type: array
          items:
            $ref: '#/components/schemas/PortfolioInstrument'
    PortfolioInstrument:
      type: object
      properties:
        product_id:
          type: integer
        bucket_type:
          type: string
          enum: [INITIAL_CAPITAL, TOP_UP]
        share_percent:
          type: number
        order_index:
          type: integer
    SystemSetting:
      type: object
      properties:
        key:
          type: string
          description: Unique setting key
        value:
          oneOf:
            - type: string
            - type: number
            - type: object
          description: Setting value (type depends on value_type)
        description:
          type: string
          description: Human-readable description
        category:
          type: string
          description: Category (calculation, pension, etc.)
        updated_at:
          type: string
          format: date-time
    CalculationRequest:
      type: object
      required:
        - goals
      properties:
        goals:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/CalculationGoal'
          description: Array of goals to calculate
        client:
          $ref: '#/components/schemas/ClientData'
          description: Client data (optional, but recommended for LIFE goals)
    CalculationGoal:
      type: object
      required:
        - goal_type_id
        - name
        - target_amount
        - term_months
        - risk_profile
      properties:
        goal_type_id:
          type: integer
          description: Portfolio class ID (from portfolio_classes). Use 5 for LIFE goals
          example: 5
        name:
          type: string
          description: Goal name
          example: "Жизнь"
        target_amount:
          type: number
          minimum: 0
          exclusiveMinimum: true
          description: |
            Target amount in currency.
            For PASSIVE_INCOME goals (goal_type_id: 2): desired monthly income (₽/month).
            For other goals: target amount to accumulate (₽).
          example: 3000000
        term_months:
          type: integer
          minimum: 1
          description: Term in months
          example: 60
        risk_profile:
          type: string
          enum: [CONSERVATIVE, BALANCED, AGGRESSIVE]
          description: Risk profile
          example: "BALANCED"
        initial_capital:
          type: number
          minimum: 0
          default: 0
          description: Initial capital (optional, default 0)
          example: 0
        inflation_rate:
          type: number
          minimum: 0
          description: Annual inflation rate in % (optional, uses system default if not provided)
          example: 4.0
        avg_monthly_income:
          type: number
          minimum: 0
          description: Среднемесячный доход ДО НДФЛ (₽/мес). Требуется для расчета софинансирования ПДС, если в портфеле есть продукт типа PDS
          example: 100000
        start_date:
          type: string
          format: date
          description: Дата начала цели (YYYY-MM-DD или ISO 8601). По умолчанию текущая дата. Используется для расчета софинансирования ПДС
          example: "2024-01-01"
        payment_variant:
          type: integer
          enum: [0, 1, 2, 4, 12]
          description: |
            Payment variant for NSJ (LIFE goals only):
            - 0: единовременно (one-time)
            - 1: ежегодно (annually)
            - 2: раз в полгода (semi-annually)
            - 4: ежеквартально (quarterly)
            - 12: ежемесячно (monthly)
          example: 0
        program:
          type: string
          description: NSJ product code (default: "base"). Used only for LIFE goals
          example: "base"
    ClientData:
      type: object
      description: Client personal data (optional, but recommended for LIFE goals)
      properties:
        birth_date:
          type: string
          format: date
          description: Client birth date (YYYY-MM-DD or ISO 8601). Required for accurate NSJ calculations
          example: "1980-01-01"
        sex:
          type: string
          enum: [male, female, M, F, мужской, женский]
          description: Client sex. Required for accurate NSJ calculations
          example: "male"
        fio:
          type: string
          description: Full name (ФИО)
          example: "Иванов Иван Иванович"
        name:
          type: string
          description: Name (alternative to fio)
          example: "Иванов Иван Иванович"
        phone:
          type: string
          description: Phone number (will be normalized to +79999999999 format)
          example: "+79990000000"
        email:
          type: string
          format: email
          description: Email address
          example: "test@example.com"
        insured_person:
          type: object
          description: Insured person data (if different from policy holder)
          properties:
            is_policy_holder:
              type: boolean
              description: Whether the insured person is the same as policy holder
              example: false
            birth_date:
              type: string
              format: date
              description: Insured person birth date (if different from policy holder)
              example: "1985-05-15"
            sex:
              type: string
              enum: [male, female, M, F]
              description: Insured person sex (if different from policy holder)
              example: "female"
    PassiveIncomeCalculationResult:
      type: object
      description: Result for PASSIVE_INCOME goal type (goal_type_id: 2)
      properties:
        goal_id:
          type: integer
          description: Goal type ID (2 for PASSIVE_INCOME)
          example: 2
        goal_name:
          type: string
          description: Goal name
          example: "Пассивный доход"
        goal_type:
          type: string
          enum: [PASSIVE_INCOME]
          description: Goal type identifier
        passive_income_calculation:
          type: object
          description: Passive income specific calculation details
          properties:
            desired_monthly_income_initial:
              type: number
              format: double
              description: Desired monthly income as specified by user (₽/month)
              example: 100000
            desired_monthly_income_with_inflation:
              type: number
              format: double
              description: Desired monthly income adjusted for inflation at goal term (₽/month)
              example: 120000
            required_capital:
              type: number
              format: double
              description: Required capital to generate desired monthly income (₽)
              example: 10000000
            yield_percent:
              type: number
              format: double
              description: Annual yield percentage used for calculation (%)
              example: 14.0
            yield_line:
              type: object
              description: Yield line used for calculation
              properties:
                min_term_months:
                  type: number
                  format: double
                  description: Minimum term in months
                max_term_months:
                  type: number
                  format: double
                  description: Maximum term in months
                min_amount:
                  type: number
                  format: double
                  description: Minimum amount
                max_amount:
                  type: number
                  format: double
                  description: Maximum amount
        financials:
          type: object
          description: Financial calculation results
          properties:
            cost_initial:
              type: number
              format: double
              description: Required capital (same as required_capital)
            cost_with_inflation:
              type: number
              format: double
              description: Required capital (inflation already applied to income, not to capital)
            inflation_annual_percent:
              type: number
              format: double
              description: Annual inflation rate used (%)
            investment_expense_growth_monthly_percent:
              type: number
              format: double
              description: Monthly investment expense growth rate (%)
            investment_expense_growth_annual_percent:
              type: number
              format: double
              description: Annual investment expense growth rate (%)
            initial_capital:
              type: number
              format: double
              description: Initial capital (₽)
            capital_gap:
              type: number
              format: double
              description: Capital shortage (₽)
            recommended_replenishment:
              type: number
              format: double
              description: Recommended monthly replenishment (₽)
            portfolio_yield_annual_percent:
              type: number
              format: double
              description: Portfolio annual yield (%)
        pds_cofinancing:
          type: object
          nullable: true
          description: PDS cofinancing calculation results (if PDS product is in portfolio)
          properties:
            cofinancing_next_year:
              type: integer
              description: Cofinancing amount for next year (₽)
            total_cofinancing_nominal:
              type: number
              format: double
              description: Total cofinancing amount (nominal, ₽)
            total_cofinancing_with_investment:
              type: number
              format: double
              description: Total cofinancing amount with investment growth (₽)
            pds_yield_annual_percent:
              type: number
              format: double
              description: PDS product annual yield (%)
            new_capital_gap:
              type: number
              format: double
              description: Capital gap after cofinancing (₽)
            yearly_breakdown:
              type: array
              description: Yearly breakdown of cofinancing
              items:
                type: object
                properties:
                  year:
                    type: integer
                    description: Year
                  capital_start_of_year:
                    type: number
                    format: double
                    description: Capital at start of year (₽)
                  client_contrib_year:
                    type: number
                    format: double
                    description: Client contributions for year (₽)
                  cofinancing_for_year:
                    type: number
                    format: double
                    description: Cofinancing calculated for this year (₽)
                  cofinancing_paid_in_year:
                    type: number
                    format: double
                    description: Cofinancing paid in this year (₽)
                  capital_end_of_year:
                    type: number
                    format: double
                    description: Capital at end of year (₽)
                  percentage_income:
                    type: number
                    format: double
                    description: Interest income for year (₽)
        error:
          type: string
          description: Error message if calculation failed
    CalculationResponse:
      type: object
      properties:
        results:
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/PortfolioCalculationResult'
              - $ref: '#/components/schemas/LifeCalculationResult'
              - $ref: '#/components/schemas/PassiveIncomeCalculationResult'
    PortfolioCalculationResult:
      type: object
      properties:
        goal_id:
          type: integer
        goal_name:
          type: string
        portfolio:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            currency:
              type: string
        products:
          type: array
          description: Array of products in the portfolio with their yields
          items:
            type: object
            properties:
              product_id:
                type: integer
                description: Product ID
              name:
                type: string
                description: Product name
              share_percent:
                type: number
                description: Share percentage in portfolio
              yield_percent:
                type: number
                description: Yield percentage for this product (matched from product yields)
              matched_line:
                type: object
                nullable: true
                description: Matched yield line from product yields
                properties:
                  term_from_months:
                    type: integer
                  term_to_months:
                    type: integer
                  amount_from:
                    type: number
                  amount_to:
                    type: number
                  yield_percent:
                    type: number
        financials:
          type: object
          properties:
            cost_initial:
              type: number
            cost_with_inflation:
              type: number
            inflation_annual_percent:
              type: number
            investment_expense_growth_monthly_percent:
              type: number
            investment_expense_growth_annual_percent:
              type: number
            initial_capital:
              type: number
            capital_gap:
              type: number
            recommended_replenishment:
              type: number
            portfolio_yield_annual_percent:
              type: number
        pds_cofinancing:
          type: object
          nullable: true
          description: Данные по софинансированию ПДС (присутствует только если в портфеле есть продукт типа PDS и указан avg_monthly_income)
          properties:
            cofinancing_next_year:
              type: number
              description: Софинансирование в следующем году (за первый год участия, ₽)
            total_cofinancing_nominal:
              type: number
              description: Номинальное софинансирование за весь период (без учета процентов, ₽)
            total_cofinancing_with_investment:
              type: number
              description: Будущая стоимость софинансирования с учетом процентов (₽)
            pds_yield_annual_percent:
              type: number
              description: Годовая доходность продукта ПДС (%)
            new_capital_gap:
              type: number
              description: Скорректированная нехватка капитала с учетом софинансирования (₽)
            yearly_breakdown:
              type: array
              description: Детализация по годам
              items:
                type: object
                properties:
                  year:
                    type: integer
                    description: Год
                  capital_start_of_year:
                    type: number
                    description: Капитал на начало года (₽)
                  client_contrib_year:
                    type: number
                    description: Взносы клиента за год (₽)
                  cofinancing_for_year:
                    type: number
                    description: Софинансирование, рассчитанное по взносам этого года (будет начислено в августе следующего года, ₽)
                  cofinancing_paid_in_year:
                    type: number
                    description: Софинансирование, реально зачисленное в этом году (за прошлый год, ₽)
                  capital_end_of_year:
                    type: number
                    description: Капитал на конец года (₽)
                  percentage_income:
                    type: number
                    description: Процентный доход за год (₽)
        error:
          type: string
          description: Error message if calculation failed
    LifeCalculationResult:
      type: object
      description: Result for LIFE goal type (NSJ calculation)
      properties:
        goal_id:
          type: integer
          description: Goal type ID (5 for LIFE)
          example: 5
        goal_name:
          type: string
          description: Goal name
          example: "Жизнь"
        goal_type:
          type: string
          enum: [LIFE]
          description: Goal type identifier
        nsj_calculation:
          type: object
          description: NSJ API calculation result
          properties:
            success:
              type: boolean
              description: Whether the calculation was successful
              example: true
            term_years:
              type: integer
              description: Insurance term in years
              example: 5
            risks:
              type: array
              description: Array of insurance risks
              items:
                type: object
                properties:
                  code:
                    type: string
                    description: Risk code (e.g., "endowment", "death")
                    example: "endowment"
                  name:
                    type: string
                    description: Risk name
                    example: "Накопительное страхование жизни"
                  type:
                    type: string
                    description: Risk type
                  participant:
                    type: string
                    description: Participant type (e.g., "insuredPerson")
                    example: "insuredPerson"
                  term:
                    type: integer
                    description: Risk term in years
                  tariff:
                    type: number
                    description: Risk tariff
                  limit:
                    type: number
                    description: Insurance sum for this risk in contract currency
                  premium:
                    type: number
                    description: Premium for this risk in contract currency
                  limitRUR:
                    type: number
                    description: Insurance sum for this risk in RUB
                  premiumRUR:
                    type: number
                    description: Premium for this risk in RUB
            total_premium:
              type: number
              description: Total premium in RUB
              example: 500000
            total_premium_rur:
              type: number
              description: Total premium in RUB (alternative field name)
              example: 500000
            total_limit:
              type: number
              description: Total insurance sum
              example: 3000000
            garantProfit:
              type: number
              description: Guaranteed profit
              example: 0
            payTerm:
              type: integer
              description: Payment term in years
              example: 5
            payEndDate:
              type: integer
              format: int64
              description: Payment end date (UNIX timestamp ms)
            comission:
              type: object
              description: Commission information
              properties:
                percent:
                  type: number
                  description: Commission percentage
                  example: 5
                amount:
                  type: number
                  description: Commission amount
                  example: 174000
            rvd:
              type: number
              nullable: true
              description: RVD (reserve for payments)
            cashSurrenderValues:
              type: array
              nullable: true
              description: Cash surrender values
              items:
                type: object
            payments_list:
              type: array
              description: Payment schedule
              items:
                type: object
                properties:
                  i:
                    type: integer
                    description: Payment number
                    example: 1
                  date:
                    type: integer
                    format: int64
                    description: Payment date (UNIX timestamp ms)
                  endDate:
                    type: integer
                    format: int64
                    description: End date of paid period (UNIX timestamp ms)
                  premium:
                    type: number
                    description: Payment amount
                    example: 3480000
                  dueDate:
                    type: integer
                    format: int64
                    description: Due date (UNIX timestamp ms)
            warnings:
              type: array
              description: Calculation warnings
              items:
                type: string
            calculation_date:
              type: integer
              format: int64
              description: Calculation timestamp (UNIX milliseconds)
        error:
          type: string
          description: Error message if NSJ calculation failed
        nsj_error_details:
          type: array
          description: Detailed error information from NSJ API
          items:
            type: object
            properties:
              tariff:
                type: number
              limit:
                type: number
              premium:
                type: number
              limitRUR:
                type: number
              premiumRUR:
                type: number
              total_premium:
                type: number
              total_premium_rur:
                type: number
              total_limit:
                type: number
              payments_list:
                type: array
                items:
                  type: object
              warnings:
                type: array
                items:
                  type: string
              calculation_date:
                type: integer
        error:
          type: string
          description: Error message if NSJ calculation failed
        nsj_error_details:
          type: object
          description: Detailed error information from NSJ API


    Client:
      type: object
      required:
        - first_name
        - last_name
      properties:
        id:
          type: integer
          readOnly: true
        first_name:
          type: string
        last_name:
          type: string
        middle_name:
          type: string
        birth_date:
          type: string
          format: date
        gender:
          type: string
          enum: [male, female]
        phone:
          type: string
        email:
          type: string
          format: email
        avg_monthly_income:
          type: number
        employment_type:
          type: string
        tax_mode:
          type: string
        assets_total:
          type: number
          readOnly: true
        liabilities_total:
          type: number
          readOnly: true
        net_worth:
          type: number
          readOnly: true
        goals_summary:
          type: array
          readOnly: true
          items:
            type: object
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true

    ClientAsset:
      type: object
      required:
        - type
        - name
        - current_value
      properties:
        id:
          type: integer
          readOnly: true
        type:
          type: string
          enum: [DEPOSIT, CASH, BROKERAGE, IIS, PDS, NSJ, REAL_ESTATE, CRYPTO, OTHER]
        name:
          type: string
        current_value:
          type: number
        currency:
          type: string
          default: RUB
        yield_percent:
          type: number
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        risk_level:
          type: string
          enum: [conservative, moderate, aggressive]

    ClientLiability:
      type: object
      required:
        - type
        - name
        - remaining_amount
        - monthly_payment
      properties:
        id:
          type: integer
          readOnly: true
        type:
          type: string
          enum: [MORTGAGE, CONSUMER_LOAN, CREDIT_CARD, AUTO_LOAN, OTHER]
        name:
          type: string
        remaining_amount:
          type: number
        monthly_payment:
          type: number
        interest_rate:
          type: number
        end_date:
          type: string
          format: date

    ClientExpense:
      type: object
      required:
        - category
        - amount
      properties:
        id:
          type: integer
          readOnly: true
        category:
          type: string
          enum: [LIVING, HOUSING, CHILDREN, LOANS, LEISURE, OTHER]
        name:
          type: string
        amount:
          type: number
        currency:
          type: string
          default: RUB

    ClientGoal:
       type: object
       required:
         - goal_type_id
         - name
       properties:
         id:
            type: integer
            readOnly: true
         goal_type_id:
            type: integer
         name:
            type: string
         target_amount:
            type: number
         desired_monthly_income:
            type: number
         term_months:
            type: integer
         risk_profile:
            type: string
         initial_capital:
            type: number
         inflation_rate:
            type: number

    FullClientRequest:
      type: object
      required:
        - client
      properties:
        client:
          $ref: '#/components/schemas/Client'
        assets:
          type: array
          items:
            $ref: '#/components/schemas/ClientAsset'
        liabilities:
          type: array
          items:
            $ref: '#/components/schemas/ClientLiability'
        expenses:
          type: array
          items:
            $ref: '#/components/schemas/ClientExpense'
        goals:
          type: array
          items:
            $ref: '#/components/schemas/ClientGoal'

    FullClientResponse:
      allOf:
        - $ref: '#/components/schemas/FullClientRequest'

security:
  - bearerAuth: []
  - apiKeyAuth: []

paths:
  /auth/login:
    post:
      summary: Login and get JWT token
      tags:
        - Authentication
      security: []  # No auth required for login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT token
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      name:
                        type: string
                      role:
                        type: string
                      agentId:
                        type: integer
        '401':
          description: Invalid credentials

  /auth/register:
    post:
      summary: Register new agent user
      tags:
        - Authentication
      security: []  # No auth required for registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
                - agentId
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 6
                name:
                  type: string
                agentId:
                  type: integer
      responses:
        '201':
          description: User created
        '400':
          description: User already exists

  /auth/me:
    get:
      summary: Get current user info
      tags:
        - Authentication
      responses:
        '200':
          description: User info
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  email:
                    type: string
                  role:
                    type: string
                  agentId:
                    type: integer

  /pfp/products:

    get:
      summary: List products
      parameters:
        - in: query
          name: includeDefaults
          schema:
            type: boolean
        - in: query
          name: product_type
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'
    post:
      summary: Create product
      requestBody:
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/Product'
      responses:
        '201':
          description: Created
  /products/{id}:
    get:
      summary: Get product by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
    put:
      summary: Update product
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Product'
      responses:
        '200':
          description: Updated
    delete:
      summary: Delete product
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
  /products/{id}/clone:
    post:
      summary: Clone default product
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '201':
          description: Cloned

  /portfolios:
    get:
      summary: List portfolios
      parameters:
        - in: query
          name: amount_from
          schema:
            type: number
      responses:
        '200':
          description: OK
    post:
      summary: Create portfolio
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Portfolio'
      responses:
        '201':
          description: Created
  /portfolios/{id}:
    get:
      summary: Get portfolio
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
    put:
      summary: Update portfolio
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Portfolio'
      responses:
        '200':
          description: Updated
    delete:
      summary: Delete portfolio
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
  /portfolios/{id}/clone:
    post:
      summary: Clone default portfolio
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '201':
          description: Cloned

  /pfp/settings:
    get:
      summary: List all system settings
      tags:
        - Settings
      parameters:
        - in: query
          name: category
          schema:
            type: string
          description: Filter by category (calculation, pension, etc.)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SystemSetting'
    post:
      summary: Create new setting (admin only)
      tags:
        - Settings
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - value
              properties:
                key:
                  type: string
                value:
                  oneOf:
                    - type: string
                    - type: number
                    - type: object
                description:
                  type: string
                category:
                  type: string
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSetting'
        '403':
          description: Forbidden (admin only)

  /pfp/settings/{key}:
    get:
      summary: Get setting by key
      tags:
        - Settings
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSetting'
        '404':
          description: Setting not found
    put:
      summary: Update setting value (admin only)
      tags:
        - Settings
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - value
              properties:
                value:
                  oneOf:
                    - type: string
                    - type: number
                    - type: object
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemSetting'
        '403':
          description: Forbidden (admin only)
        '404':
          description: Setting not found
    delete:
      summary: Delete setting (admin only)
      tags:
        - Settings
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '403':
          description: Forbidden (admin only)
        '404':
          description: Setting not found

  # ============================================
  # CLIENT API (Public, no authentication)
  # ============================================
  /client:
    post:
      summary: Create new client profile (Full)
      tags:
        - Client API
      security: []
      description: |
        Creates a new client profile along with assets, liabilities, and expenses.
        Automatically calculates Net Worth and other aggregates.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FullClientRequest'
      responses:
        '201':
          description: Client created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullClientResponse'
        '400':
          description: Validation error

  /client/{id}:
    get:
      summary: Get full client profile
      tags:
        - Client API
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Full client profile found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullClientResponse'
        '404':
          description: Client not found

    put:
      summary: Update client profile
      tags:
        - Client API
      security: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FullClientRequest'
      responses:
        '200':
          description: Client updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullClientResponse'
        '501':
          description: Not implemented yet

  /client/calculate:
    post:
      summary: Calculate financial plan for goals (Client API - Public)
      tags:
        - Client API
      security: []  # No authentication required
      description: |
        Calculate financial plan for one or more goals.
        
        **Special handling for LIFE goals (goal_type_id: 5):**
        - If a goal has `goal_type_id: 5` or `name: "Жизнь"`, the system will call the external NSJ (Life Insurance) API
        - For LIFE goals, client data (birth_date, sex) is recommended for accurate calculations
        - LIFE goals return NSJ calculation results instead of portfolio-based calculations
        
        **Special handling for PASSIVE_INCOME goals (goal_type_id: 2):**
        - For PASSIVE_INCOME goals, `target_amount` represents desired monthly income (₽/month), not a target capital amount
        - The system calculates required capital based on:
          1. Desired monthly income adjusted for inflation at goal term
          2. Yield percentage from passive income yield settings (matched by term only)
        - Formula: `required_capital = (desired_monthly_income_with_inflation * 12 * 100) / yield_percent`
        - The calculation then proceeds with standard replenishment logic using the calculated required capital
        - Inflation is applied to income, not to capital (no double inflation)
        - Returns `PassiveIncomeCalculationResult` with detailed breakdown
        
        **PDS Cofinancing (automatic calculation):**
        - If a portfolio contains a product with `product_type: "PDS"`, the system automatically calculates PDS cofinancing effect
        - For PDS cofinancing calculation, provide `avg_monthly_income` in the goal (average monthly income BEFORE NDFL deduction)
        - The cofinancing result is included in `pds_cofinancing` field of `PortfolioCalculationResult` or `PassiveIncomeCalculationResult`
        - Cofinancing reduces the capital gap and adjusts recommended monthly replenishment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculationRequest'
      responses:
        '200':
          description: Calculation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: array
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                        message:
                          type: string
        '500':
          description: Internal server error
